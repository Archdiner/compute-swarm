# GPU-enabled Sandbox Docker image for ComputeSwarm job execution
# Provides isolated Python environment with CUDA and PyTorch GPU support

FROM nvidia/cuda:12.1.0-runtime-ubuntu22.04

# Prevent interactive prompts during installation
ENV DEBIAN_FRONTEND=noninteractive

# Security: Create non-root user
RUN useradd -m -u 1000 -s /bin/bash sandbox

# Install system dependencies for ML libraries
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3 \
    python3-pip \
    python3-dev \
    gcc \
    g++ \
    libffi-dev \
    libssl-dev \
    git \
    wget \
    curl \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# Upgrade pip
RUN pip3 install --no-cache-dir --upgrade pip

# Install PyTorch with CUDA 12.1 support
RUN pip3 install --no-cache-dir \
    torch \
    torchvision \
    torchaudio \
    --index-url https://download.pytorch.org/whl/cu121

# Install common ML/scientific packages
RUN pip3 install --no-cache-dir \
    numpy>=1.24.0 \
    scipy>=1.11.0 \
    pandas>=2.0.0 \
    scikit-learn>=1.3.0 \
    matplotlib>=3.7.0 \
    pillow>=10.0.0 \
    requests>=2.31.0 \
    tqdm>=4.65.0

# Install transformers and related libraries for LLM/AI workloads
RUN pip3 install --no-cache-dir \
    transformers>=4.35.0 \
    accelerate>=0.24.0 \
    datasets>=2.14.0 \
    tokenizers>=0.15.0 \
    sentencepiece>=0.1.99 \
    safetensors>=0.4.0

# Install additional ML frameworks
RUN pip3 install --no-cache-dir \
    xgboost>=2.0.0 \
    lightgbm>=4.1.0 \
    optuna>=3.4.0

# Install PEFT for efficient fine-tuning (LoRA, QLoRA)
RUN pip3 install --no-cache-dir \
    peft>=0.6.0 \
    bitsandbytes>=0.41.0

# Clean up pip cache
RUN pip3 cache purge

# Create workspace and cache directories
WORKDIR /workspace
RUN mkdir -p /root/.cache/huggingface /root/.cache/torch

# Set environment variables for GPU and caching
ENV NVIDIA_VISIBLE_DEVICES=all
ENV NVIDIA_DRIVER_CAPABILITIES=compute,utility
ENV HF_HOME=/root/.cache/huggingface
ENV TORCH_HOME=/root/.cache/torch
ENV TRANSFORMERS_CACHE=/root/.cache/huggingface/transformers

# Default command - will be overridden by job execution
CMD ["python3", "--version"]

# Labels
LABEL org.opencontainers.image.title="ComputeSwarm GPU Sandbox"
LABEL org.opencontainers.image.description="CUDA-enabled Python execution environment for ComputeSwarm GPU jobs"
LABEL org.opencontainers.image.version="1.0.0"

